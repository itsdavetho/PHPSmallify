<?php namespace Orpheus; class PHPSmallify{protected $h=array('_GET','_POST','_COOKIE','_SESSION','_SERVER','GLOBALS','_FILES','_REQUEST','_ENV','php_errormsg','HTTP_RAW_POST_DATA','http_response_header','argv','argc','this');protected $x=array('f','__destruct','__call','__callStatic','__get','__set','__isset','__unset','__sleep','__wakeup','__toString','__invoke','__set_state','__clone');protected $o=null,$ob=null,$k;protected $d=array(),$n=array(); public function f($r=null,$l=null){if($r!==null&&$l===null){$this->w($r);}else if($l!==null&&$r===null){$this->o=$l;$this->k=strlen($this->o);}} public function w($r){if(is_file($r)){$this->o=file_get_contents($r);$this->k=strlen($this->o);}else{throw new\Exception(__METHOD__.': "'.$r.'" does not exist.');}} public function k($b){return preg_match('/[a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff]*/',$b);} public function c($u,$a=4){$xu=$u;$w=array('base64_encode'=>'base64_decode','str_rot13'=>'str_rot13');$g=array();for($i=0;$i<$a;$i++){$hr=array_rand($w);$xu=$hr($xu);$e=$w[$hr];$g[]=$e;}$s='';foreach($g as $e){$s.=$e.'(';}$s.='"'.$xu.'"';$s.=str_repeat(')',$a);return $s;} public function t($c=true,$v=true,$dz=true,$bx=false,$dm=false,$ba=false){if($this->o==null){throw new\Exception(__METHOD__.': Need to load PHP code first.');}$this->o=mb_convert_encoding($this->o,'UTF-8');$j=token_get_all($this->o);$this->ob=null;$q=range('a','z');shuffle($q);$bz=count($q);$z=array();$y=array();$t=array();$p=false;foreach($j as $jx=>$m){if(!is_array($m)){$this->ob.=$m;continue;}if(($m[0]==T_VARIABLE||(isset($j[$jx-2])&&$j[$jx-2][0]==T_VARIABLE&&$j[$jx-2][1]=='$this'&&isset($j[$jx-1])&&$j[$jx-1][0]=T_OBJECT_OPERATOR&&$j[$jx+1]!='('))&&!in_array(substr($m[1],1),$this->h)){if((isset($j[$jx-2])&&$j[$jx-2][0]==T_VARIABLE)&&(isset($j[$jx-1])&&$j[$jx-1][0]==T_OBJECT_OPERATOR)){$ek='';}else{$ek='$';}if($dz&&!$p){if(substr($m[1],0,1)=='$'){$m[1]=substr($m[1],1);}if(isset($y[$m[1]])){$m[1]=$ek.$y[$m[1]];}else{$bt=$m[1];$i=array_rand($q);$m[1]=$q[$i];while(in_array($m[1],$z)){$m[1].=$q[array_rand($q)];}$z[]=$m[1];$y[$bt]=$m[1];$m[1]=$ek.$m[1];}}}if($bx&&!$p&&$m[0]==T_FUNCTION){$on=$jx+2;if(isset($j[$on],$j[$on][0],$j[$on][1])&&$j[$on][0]==T_STRING){$kw=$j[$on][1];$zk=$q[array_rand($q)];while(in_array($zk,$t)){$zk.=$q[array_rand($q)];}$t[$kw]=$zk;}}if($dm&&!$p){if($m[0]==T_CONSTANT_ENCAPSED_STRING){$u=substr($m[1],1);$u=substr($u,0,-1);$u=$this->c($u);$m[1]=$u;}}if($m[0]==T_COMMENT||$m[0]==T_DOC_COMMENT){$eh=trim($m[1]);if($eh=='//t-ignore'||$eh=='/*t-ignore*/'){$p=true;}if($eh=='//t-ignore-end'||$eh=='/*t-ignore-end*/'){$p=false;}}if($c&&($m[0]==T_COMMENT||$m[0]==T_DOC_COMMENT)){continue;}if($v&&$m[0]==T_WHITESPACE){if(isset($j[$jx-1])&&isset($j[$jx+1])&&is_array($j[$jx-1])&&is_array($j[$jx+1])&&$this->k($j[$jx-1][1])&&$this->k($j[$jx+1][1])){$this->ob.=' ';}continue;}$this->ob.=$m[1];}foreach($t as $co=>$pd){$this->ob=preg_replace('/'.$co.'/u',$pd,$this->ob);}if($ba){$this->ob=$this->c($this->ob);}$ep=strlen($this->ob)/$this->k;$ld=1-(strlen($this->ob)/$this->k);return array('smallified'=>$this->ob,'initial_size'=>$this->k,'new_size'=>strlen($this->ob),'compression_ratio'=>$ep,'space_savings'=>$ld*100);}}

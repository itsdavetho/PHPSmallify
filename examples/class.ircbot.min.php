<?php
  session_start();chdir(dirname(__FILE__));date_default_timezone_set('America/Vancouver');class IRCBot{protected $a;protected $b;protected $c;protected $d=array();protected $e=array();protected $f;protected $g=false;protected $h=''; public function __construct(array $i=array(),$j=null){if(count($i)>0)$this->d=array_merge($i,$this->d);else{$k=array('IRC_PORT'=>6667,'IRC_NICK'=>'PHPIRCBot','IRC_USER'=>'PHPIRCBot','OWNER'=>'PHPIRCBot');$this->d=array_merge($k,$this->d);}$this->loadModules($j);} public function start(){$this->a=@fsockopen($this->getArg('IRC_SERVER'),intval($this->getArg('IRC_PORT')),$l,$m);if(!$this->a)Throw new Exception($m);$this->sendCommand('USER '.$this->getArg('IRC_USER').' 0 * '.$this->getArg('IRC_USER'));$this->sendCommand('NICK '.$this->getArg('IRC_NICK'));while($this->a){$this->b=fgets($this->a,1024);$this->c=$this->parseMessage($this->b);if($this->g)ob_start();$this->handleCommand($this->c['command']);if($this->g){$n=ob_get_clean();$this->h.=$n;echo $n;}if(substr($this->c['trail'],0,1)=='!'){ob_start();$this->o=preg_replace('/(\s*)([^\s]*)(.*)/','$2',$this->c['trail']);$this->handleModule(substr($this->o,1));$n=ob_get_clean();if($this->g)$this->h.=$n;if(!empty($n)){$n=explode("\n",$n);foreach($n as $p){if(strlen(trim($p))==0)continue;$p=str_replace("   ",'  ',$p);if($this->c['isPM']==true)$this->sendCommand('PRIVMSG '.$this->c['username'].' :'.$p);else $this->sendMessage($p);}}}if($this->g)$this->pushLog();}} public function getResultSet(){return $this->c;} public function sendCommand($q){if(!$this->a)Throw new Exception('No connection opened');fwrite($this->a,$q."\r\n");fflush($this->a);echo $q.PHP_EOL;return true;} public function sendMessage($r,$s=false){if($s==false)$s=$this->c['args'];$this->sendCommand('PRIVMSG '.$s.' :'.$r);} public function parseMessage($t){preg_match('/^(?:[:@]([^\\s]+) )?([^\\s]+)(?: ((?:[^:\\s][^\\s]* ?)*))?(?: ?:(.*))?$/',$t,$i);if(isset($i[1]))if(strrpos($i[1],'!'))$u=substr($i[1],0,strrpos($i[1],'!'));else $u=$i[1];else $u='';if(isset($i[3]))$v=trim(strtolower($i[3]))==strtolower($this->d['IRC_NICK'])?true:false;else $v=false;return array('username'=>$u,'command'=>isset($i[2])?$i[2]:'','trail'=>isset($i[4])?trim($i[4]):'','args'=>isset($i[3])?$i[3]:'','isPM'=>$v);} public function loadModules($j=null){if(is_null($j))$j=dirname(__FILE__).'\\modules';else if(!is_dir($j))Throw new Exception($j.' is not a valid directory');$w=glob($j.'\\*.php');foreach($w as $x){$y=basename($x,'.php');if(!class_exists($y))require_once($x);else echo 'Module "'.$y.'"" already loaded!'.PHP_EOL;if(class_exists($y)){$this->e[$y]=new $y($this);}else echo 'Module "'.$j.'\\'.$y.'.php" could not be loaded! Class name must match that of the filename!'.PHP_EOL;}} public function getModules(){return $this->e;} public function handleCommand($aa){if($aa=='PING'){$this->sendCommand('PONG '.substr($this->b,5));}if(!isset($this->f[$aa])||$aa=='PING'){$bb=$this->getResultSet();foreach($bb as $cc){if(empty($cc)){$dd=true;}else{$dd=false;}}if(isset($dd)&&$dd===false)echo'['.date('h:i').'] <'.trim($bb['username']).':'.$bb['command'].'> '.trim($bb['trail']).PHP_EOL;return false;}foreach($this->f[$aa]as $ee)$ee($this);foreach($this->e as $ff){if(method_exists($ff,'EVENT_'.$aa)){$aa='EVENT_'.$aa;$ff->aa($this,$this->getResultSet());}}return true;} public function getCurrentCommand(){return $this->o;} public function handleModule($ff){if(isset($this->e[$ff])){$i=$this->c['trail'];$i=substr($i,strlen($this->o)+1);$ff=$this->e[$ff];$hh=array('pre_execute','execute','post_execute'); foreach($hh as $ii)if(method_exists($ff,$ii))$ff->ii($this,$i);return true;}else return false;} public function addHandler($aa,closure $ee){if(!isset($this->f[$aa]))$this->f[$aa]=array();$this->f[$aa][]=$ee;return key(end($this->f));} public function removeHandler($aa,$jj){if(!isset($this->f[$aa][$jj]))return false;unset($this->f[$aa][$jj]);return true;} public function setArg($kk,$ll){$this->d[$kk]=$ll;return $this->d[$kk];} public function getArg($kk){if(isset($this->d[$kk]))return $this->d[$kk];return null;} public function toggleLogging(){$this->g=!$this->g;} public function pushLog(){$mm='logs/'.date('d-M-Y').'--log.txt';if(!is_file($mm))file_put_contents($mm,'');file_put_contents($mm,$this->h,FILE_APPEND);$this->h='';} public function file_get_contents_2($nn){$oo=curl_init($nn);curl_setopt_array($oo,array(CURLOPT_RETURNTRANSFER=>true,CURLOPT_CONNECTTIMEOUT=>30,CURLOPT_TIMEOUT=>10,CURLOPT_FOLLOWLOCATION=>true,CURLOPT_HEADER=>true,CURLOPT_USERAGENT=>'Mozilla/5.0 (Windows NT 6.1; rv:16.0) Gecko/20100101 Firefox/16.0',CURLOPT_REFERER=>$nn));$pp=curl_exec($oo);return $pp;}}?>

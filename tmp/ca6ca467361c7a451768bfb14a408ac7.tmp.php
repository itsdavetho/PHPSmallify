<?php namespace Orpheus;class PHPSmallify{protected $a=array('_GET','_POST','_COOKIE','_SESSION','_SERVER','GLOBALS','_FILES','_REQUEST','_ENV','php_errormsg','HTTP_RAW_POST_DATA','http_response_header','argv','argc','this');protected $b=null,$c=null,$d;protected $e=array(),$f=array();public function __construct($g=null,$h=null){if($g!==null&&$h===null){$this->loadFile($g);}else if($h!==null){$this->loadPHPCode($h);}}public function loadPHPCode($h){$i=__DIR__.'/tmp/'.md5($h).'.tmp.php';file_put_contents($i,$h);chmod($i,0777);if($this->php_check_syntax($i,$j)){$this->b=$h;}else{throw new\Exception(__METHOD__.': The PHP contains syntax errors.');}unlink($i);}public function loadFile($g){if(is_file($g)){if($this->php_check_syntax($g,$j)==false){throw new\Exception(__METHOD__.': "'.$g.'" contains syntax errors: '.$j[0]);}$this->b=file_get_contents($g);$this->d=strlen($this->b);}else{throw new\Exception(__METHOD__.': "'.$g.'" does not exist.');}}public function validPHP($k){return preg_match('/[a-zA-Z_\x7f-\xff][a-zA-Z0-9_\x7f-\xff]*/',$k);}public function smallify($l=true,$m=false,$n=true){if($this->b==null){throw new\Exception(__METHOD__.': Need to load PHP code first.');}$o=token_get_all($this->b);$this->c=null;$p=range('a','z');$q=count($p);$r=array();$s=array();$t=0;foreach($o as $u=>$v){if(!is_array($v)){$this->c.=$v;continue;}if(($v[0]==T_VARIABLE||(isset($o[$u-2])&&$o[$u-2][0]==T_VARIABLE&&$o[$u-2][1]=='$this'&&isset($o[$u-1])&&$o[$u-1][0]=T_OBJECT_OPERATOR&&$o[$u+1]!='('))&&!in_array(substr($v[1],1),$this->a)){if((isset($o[$u-2])&&$o[$u-2][0]==T_VARIABLE)&&(isset($o[$u-1])&&$o[$u-1][0]==T_OBJECT_OPERATOR)){$w='';}else{$w='$';}if(substr($v[1],0,1)=='$'){$v[1]=substr($v[1],1);}if(isset($s[$v[1]])){$v[1]=$w.$s[$v[1]];}else{$x=$v[1];$v[1]=$p[$t];while(in_array($v[1],$r)){$v[1].=$p[$t];}$r[]=$v[1];$s[$x]=$v[1];$v[1]=$w.$v[1];$t++;}}if($l&&$v[0]==T_COMMENT||$v[0]==T_DOC_COMMENT){continue;}if($n&&$v[0]==T_WHITESPACE){if(isset($o[$u-1])&&isset($o[$u+1])&&is_array($o[$u-1])&&is_array($o[$u+1])&&$this->validPHP($o[$u-1][1])&&$this->validPHP($o[$u+1][1])){$this->c.=' ';}continue;}if($m&&$v[0]==T_CONSTANT_ENCAPSED_STRING){$v[1]='str_rot13(base64_decode(strrev("'.strrev(base64_encode(str_rot13(substr($v[1],1,-1)))).'")))';}$this->c.=$v[1];if($t>=$q-1){$t=0;}}$y=token_get_all($this->c);$aa=strlen($this->c)/$this->d;$bb=1-(strlen($this->c)/$this->d);$i=__DIR__.'/'.md5($this->c).'.tmp.php';file_put_contents($i,$this->c);chmod($i,0777);$cc=$this->php_check_syntax($i,$j);if(!$cc){var_dump($j);throw new\Exception(__METHOD__.': The minified PHP code contains errors. Please notify the developer.');}unlink($i);return array('smallified'=>$this->c,'initial_size'=>$this->d,'new_size'=>strlen($this->c),'compression_ratio'=>$aa,'space_savings'=>$bb*100);}public function php_check_syntax($g,&$j){$dd='php -l '.escapeshellarg($g).' 2>&1';$ee=exec($dd,$ff,$gg);if(preg_match('/no syntax errors/i',$ee)){return true;}else{reset($ff);end($ff);$hh=key($ff);unset($ff[$hh]);reset($ff);$j=$ff;return false;}}}?>